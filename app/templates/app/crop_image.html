{% extends "app/main.html" %} {% load static %} {% block content %}


<link href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet">

<script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>

<style>
  img {
    display: block;
    max-width: 100%;
  }

  .side-by-side {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 20px;
    margin-top: 20px;
    flex-wrap: wrap;
    /* makes it responsive */
  }


  .main-container {
    width: 35vw;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .img-container {
    margin-bottom: 10px;
  }

  .cropped-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 350px;
    height: 400px;
    background-color: ghostwhite;
    padding: 20px;
  }

  #btn-crop {
    appearance: none;
    background-color: #088112;
    border: 2px solid #088112;
    border-radius: 15px;
    box-sizing: border-box;
    color: #ffffff;
    cursor: pointer;
    display: inline-block;
    font-family: Roobert, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica,
      Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    font-size: 16px;
    font-weight: 600;
    line-height: normal;
    min-width: 0;
    margin-left: auto;
    margin-right: auto;
    outline: none;
    padding: 10px 12px;
    text-align: center;
    text-decoration: none;
    transition: all 300ms cubic-bezier(0.23, 1, 0.32, 1);
    user-select: none;
    -webkit-user-select: none;
    touch-action: manipulation;
    width: 100px;
    will-change: transform;
  }

  #btn-crop:disabled {
    pointer-events: none;
  }

  #btn-crop:hover {
    box-shadow: rgba(0, 0, 0, 0.25) 0 8px 15px;
    transform: translateY(-2px);
  }

  #btn-crop:active {
    box-shadow: none;
    transform: translateY(0);
  }

  #output {
    margin: 0 5px;
    display: block;
    max-width: 100%;
  }

  /* media queries */
  @media (max-width: 768px) {
    .main-container {
      width: 90vw;
    }

    .cropped-container {
      width: 90vw;
      height: auto;
    }
  }
</style>



<div class="input-row">
  <h1 class="text-center">Upload and Crop Your Image</h1>
  <div class="d-flex flex-column align-items-center justify-content-center gap-4">
    <input type="file" id="imageInput" name="image" accept="image/*">
    <form method="POST" action="{% url 'crop_image' profile_id=profile_id %}" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="profile_pic" id="profilePicInput">

      <input class="btn btn-success" type="submit" name="profile-pic" value="update-image">
    </form>
  </div>
</div>
<div class="side-by-side">
  <div class="main-container">
    <div class="img-container">
      <img id="image" src="">
    </div>
  </div>

  <div class="cropped-container">
    <h3>Preview</h3>
    <img src="" id="output">
  </div>
</div>
<div id="loadingOverlay" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(255, 255, 255, 0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  display: none;
">
  <canvas id="dotlottie-canvas" style="width: 300px; height: 300px;"></canvas>

</div>
<script type="module">
  import { DotLottie } from "https://cdn.jsdelivr.net/npm/@lottiefiles/dotlottie-web/+esm";

  window.DotLottie = DotLottie; // expose to global scope
</script>
<script>
  const imageInput = document.getElementById("imageInput");
  const image = document.getElementById("image");
  const output = document.getElementById("output");
  const hiddenInput = document.getElementById("profilePicInput");
  const form = document.querySelector("form");

  let cropper;

  imageInput.addEventListener("change", function (event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
      image.src = e.target.result;

      image.onload = function () {
        // Validate image dimensions
        if (image.naturalWidth < 350 || image.naturalHeight < 350) {
          alert("Image is too small. It must be at least 350 pixels in both width and height.");
          image.src = ""; // Clear preview
          output.src = ""; // Clear cropped preview
          imageInput.value = ""; // Clear the file input
          if (cropper) cropper.destroy(); // Destroy old cropper if any
          cropper = null; // Reset cropper
          return;
        }

        // If valid, proceed to create cropper
        if (cropper) {
          cropper.destroy();
        }

        cropper = new Cropper(image, {
          aspectRatio: 1,
          cropBoxResizable: false,
          cropBoxMovable: true,
          dragMode: "move",
          viewMode: 1,
          ready() {
            document.querySelector(".cropped-container").style.display = "flex";
          },
          crop() {
            const canvas = cropper.getCroppedCanvas({
              width: 350,
              height: 350,
              fillColor: "#fff",
            });
            output.src = canvas.toDataURL("image/jpeg", 1);
          },
        });
      };
    };
    reader.readAsDataURL(file);
  });

  // Handle form submit to backend: convert cropped image to Blob and append to FormData
  form.addEventListener("submit", function (e) {
    e.preventDefault(); // Prevent default submit

    if (!cropper) {
      alert("Please select and crop an image first.");
      return;
    }

    // animation 
    // Show loading overlay
    const overlay = document.getElementById("loadingOverlay");
    overlay.style.display = "flex";

    // Start the Lottie animation
    const dotLottie = new window.DotLottie({
      autoplay: true,
      loop: true,
      canvas: document.getElementById("dotlottie-canvas"),
      src: "https://lottie.host/047bfc54-8fe2-42d2-9631-ac15e86e346b/c4UbKclfSF.lottie", // or .json file
    });

    // Get the cropped canvas and convert to Blob
    cropper.getCroppedCanvas({
      width: 350,
      height: 350,
      fillColor: "#fff",
    }).toBlob(function (blob) {
      // Create a new FormData object and append the cropped image blob
      const formData = new FormData();
      formData.append("csrfmiddlewaretoken", document.querySelector("[name=csrfmiddlewaretoken]").value);
      formData.append("profile_pic", blob, "cropped.jpg");

      // Send the form data via fetch
      fetch(form.action, {
        method: "POST",
        body: formData
      }).then(response => {
        if (response.redirected) {
          window.location.href = response.url; // Handle Django redirect
        } else {
          return response.text().then(data => console.log("Upload failed", data));
        }
      }).catch(error => {
        console.error("Error uploading image:", error);
      });
    }, "image/jpeg");
  });
</script>


{% endblock %}