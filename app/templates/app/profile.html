{% extends "app/main.html" %}
{% block content %}
{% load account %}
{% load static %}

{% if is_first_visit %}
<!-- tourguide tags -->
<script src="https://unpkg.com/@sjmc11/tourguidejs/dist/tour.js" crossorigin="anonymous" referrerpolicy="no-referrer">
</script>
<link rel="stylesheet" href="https://unpkg.com/@sjmc11/tourguidejs/dist/css/tour.min.css">
{% endif %}

<style>
	.profile-pic {
		width: 200px;
		height: 200px;
		margin: 0 auto;
		border-radius: 50%;
		object-fit: cover;
	}

	.avatar {
		width: 50px;
		height: 50px;
		border-radius: 50%;
		margin-right: 5px;
		object-fit: cover;
	}

	hr.style-one {
		border: 0;
		height: 1px;
		background: #333;
		background-image: linear-gradient(to right, #ccc, #333, #ccc);
	}

	/* status post styles
.placeholder-italic::placeholder {
	font-style: italic;
}

#datetime {
	font-size: 0.9em;
	color: #666;
}

#status-container {
	border: 1px solid #d3d3d3;
	border-radius: 8px;
	padding: 16px;
	background-color: #f9f9f9;
}
*/


	/* user photo gallery */
	.gallery-grid {
		display: flex;
		gap: 10px;
		flex-wrap: wrap;
		justify-content: center;
	}

	.add-photo-box {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 160px;
		height: 220px;
		border: 2px dashed #bbb;
		border-radius: 12px;
		cursor: pointer;
		transition: all 0.3s ease;
		margin: 0 auto;
	}

	.add-photo-box:hover {
		border-color: #28a745;
		background-color: #f9f9f9;
	}

	.plus-sign {
		font-size: 64px;
		color: #999;
		line-height: 1;
		user-select: none;
	}

	.add-photo-box:hover .plus-sign {
		color: #28a745;
	}

	.gallery-grid label img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		border-radius: 12px;
	}

	.photo-slot {
		position: relative;
		width: 160px;
		height: 220px;
		border-radius: 12px;
		overflow: hidden;
		background-color: #f8f9fa;
		display: flex;
		align-items: center;
		justify-content: center;
		flex-shrink: 0;
	}

	.uploaded-photo {
		width: 100%;
		height: 100%;
		object-fit: cover;
		border-radius: 12px;
		display: block;
		cursor: pointer;
	}

	.remove-btn {
		position: absolute;
		top: 6px;
		right: 6px;
		background: rgba(0, 0, 0, 0.55);
		border: none;
		color: #fff;
		font-size: 14px;
		line-height: 1;
		border-radius: 50%;
		width: 26px;
		height: 26px;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		z-index: 10;
	}

	.remove-btn:hover {
		background: #ffc107;
	}

	#modal-image {
		max-width: 100%;
		height: auto;
		display: block;
		margin: auto;
		width: auto;
	}

	#vistor-image {
		width: 180px;
		height: 240px;
		overflow: hidden;
		border-radius: 12px;
		cursor: pointer;
	}

	#vistor-thumbnail {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}
</style>

<section>
	<div class="container mt-2">
		{% if messages %}
		<div>
			{% for message in messages %}
			<div class="alert alert-success alert-dismissible fade show" role="alert">
				{{ message }}
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
			{% endfor %}
		</div>
		{% endif %}
		<div class="row">

			<!-- column 1 -->
			<div class="col-md">
				<!-- user name and profile image -->
				<div class="card card-body mb-2">
					<form action="#" method="post" class="w-100">
						{% if request.user.profile != profile %}
						{% csrf_token %}
						{% if button == "Add" %}
						<form action="#" method="post" class="w-100">
							{% csrf_token %}
							<button class="btn btn-success w-100" name="friend-button" value="Add">
								Add Friend
							</button>
						</form>
						{% elif button == "Pending" %}
						{% csrf_token %}
						<button disabled class="btn btn-danger w-100" name="friend-button" value="Pending">
							Friend Request Pending
						</button>
						{% elif button == "Accepted" %}
						<p>You and {{ profile.user.first_name }} are friends</p>
						{% endif %}
						{% endif %}
					</form>
					<!-- message button -->
					{% if request.user.profile != profile %}
					{% if is_friend %}
					<a class="btn btn-warning mt-2" href="#" data-bs-toggle="modal" data-bs-target="#reg-modal">Message</a>
					{% else %}
					<a class="btn btn-warning mt-2" href="#" data-bs-toggle="modal" data-bs-target="#exampleModal">Message</a>
					{% endif %}
					{% else %}
					<!-- user settings link -->
					<a href="{% url 'profile_settings' profile.id %}" class="btn btn-warning w-100 mt-2"
						data-tg-tour='<h5>Profile Settings</h5><p>Adjust your personal settings here such as your name, email address, sms and email notification preferences.</p>'
						data-tg-order="1">User
						settings</a>
					{% endif %}
					<hr class="style-one" />
					<h3 style="text-align: center">
						{{ profile.user.first_name }} {{profile.user.last_name|slice:":1" }}
					</h3>
					<hr class="style-one" />
					{% if profile.profile_pic %}
					<img class="profile-pic" src="{{profile.profile_pic.url}}" />
					{% else %}
					<img class="profile-pic" src="{% static 'placeholder/profile2.png' %}" alt="Default Profile Picture" />
					{% endif %}



				</div>
				{% if request.user.profile == profile %}
				<!-- profile pic form -->
				<div class="card card-body mb-2 d-flex justify-content-center align-items-center">
					<a href="{% url 'crop_image' profile_id=profile.id %}">
						<button class="btn btn-success"
							data-tg-tour="<h5>ðŸ‘‹ Let's take a quick tour of your profile</h5><p>Get started by uploading a profile picture. Bigger, high resolution images are better.</p>"
							data-tg-order="0">Select Profile Picture</button>
					</a>

				</div>


				<!-- profile description -->
				<div class="card card-body mb-2"
					data-tg-tour="<h5>Enter some info about yourself</h5> <p>A quick sentence or two, age band and hit the 'Update About' button.</p>"
					data-tg-order="3">
					<form method="POST" action="">
						{% csrf_token %}
						{{ description_form.as_p }}
						<button class="btn btn-success mt-2" type="submit" name="update-description">Update About</button>
					</form>
				</div>
				{% else %}
				<!-- display age band and description as plain text -->
				{% if profile.description or profile.age_band != "rather_not_say" %}
				<div class="card card-body mb-2">
					{% if profile.description %}
					<h4>About Me</h4>
					<p>{{ profile.description }}</p>
					{% endif %}
					{% if profile.age_band != "rather_not_say" %}
					<h4>Age Band</h4>
					<p>{{ profile.get_age_band_display }}</p>
					{% endif %}
				</div>
				{% endif %}



				{% endif %}
			</div>


			<!-- column 2 -->
			<div class="col-md">
				<!-- status-update form -->
				<!-- {% if request.user.profile == profile %} -->
				<!-- <div class="card card-body mb-2"> -->

				<!-- Button container for update and clear buttons -->
				<!-- <div class="status-buttons">
						<h2>Post a Status</h2>
						<form method="POST" action="" enctype="multipart/form-data" style="display:inline-block;">
							{% csrf_token %}
							{{ status_form.as_p }} -->

				<!-- <input class="btn btn-success" type="submit" name="status-update" value="Update Status">
							{% if latest_status_update %}

							{% endif %} -->
				<!-- latest status update -->
				<!-- {% if latest_status_update %}
							<hr class="style-one">
							<div class="status-update">
								<h4>Current Status: </h4>
								<p id="status-container">{{ latest_status_update.content }}</p>
								<p id="datetime">Posted on {{ latest_status_update.date_posted|date:"F j, Y, g:i a" }}</p>
								<a href="{% url 'post_detail' status_id=latest_status_update.id %}" class="btn btn-success mt-2">Go to
									Status</a>
								<input class="btn btn-warning mt-2" id="clear-status-btn" type="submit" value="Clear Status">
							</div>
							{% endif %} -->
				<!-- end latest status update -->
				<!-- </form> -->


				<!-- <form method="POST" action="" id="clear-status-form" style="display:inline-block;">
							{% csrf_token %}
							<input type="hidden" name="clear-status" value="true">
						</form>
					</div>


				</div>
				{% endif %} -->
				<!-- end update status form -->

				<!-- Events section -->

				<div class="card card-body mb-2"
					data-tg-tour="<h5>All your event details are here.</h5> <p>What events you are attending or hosting. Click the 'Event Requests' button to see your event requests.</p>"
					data-tg-order="4">
					<div>
						<h1>Events Attending</h1>
						<ul class="list-unstyled">
							{% for event in attended_events %}
							<li>
								<a href="{% url 'event' event.id %}" class="text-decoration-none">
									<img class="avatar" src="{{ event.host.profile_pic.url }}" alt="Avatar">
									{{ event.event_title }}
								</a>
							</li>
							<hr class="style-one">
							{% empty %}
							<li><em>No events to show</em></li>
							{% endfor %}
						</ul>

						<h1 class="mt-5">Events Hosting </h1>
						<ul class="list-unstyled">
							{% for event in hosted_events %}
							<li>
								<a href="{% url 'event' event.id %}" class="text-decoration-none">
									<img class="avatar" src="{{ event.host.profile_pic.url }}" alt="Avatar">
									{{ event.event_title }}
								</a>
							</li>
							<hr class="style-one">
							{% empty %}
							<li><em>No events to show</em></li>
							{% endfor %}
						</ul>
						{% if request.user.profile == profile %}
						<a href="{% url 'event_requests' profile.id %}" class="btn btn-success w-100">Event Requests</a>
						{% endif %}
					</div>
				</div>

				<!-- end event section -->

				<!-- Friends section -->

				<div class="card card-body mb-2"
					data-tg-tour="<h5>Here are your friends.</h5> <p>Click the link to see your friend list or click the 'Friend Requests' button to see your friend requests.</p>"
					data-tg-order="5">
					<div>
						<a class="mb-3 d-inline-block text-decoration-none" href="{% url 'friends' profile.id %}">
							<h1>Friends {% if friends.count > 0 and friend_visibility %} ({{ friends.count }}) {% endif %}</h1>
						</a>
						<ul class="list-unstyled">
							{% if friends %}
							{% for friend in friends %}
							<li class="mb-2">
								<a href="{% url 'profile' friend.id %}" class="text-decoration-none">
									{% if friend.profile_pic %}
									<img class="avatar" src="{{ friend.profile_pic.url }}" alt="Avatar">
									{% else %}
									<img class="avatar" src="{% static 'images/default_profile_pic.png' %}" alt="Avatar">
									{% endif %}
									{{ friend.user.first_name }}
								</a>
							</li>
							<hr class="style-one">
							{% endfor %}
							{% else %}
							<p><em>No friends showing</em></p>
							{% endif %}
						</ul>
						{% if request.user.profile == profile %}
						<a href="{% url 'friend_requests' profile.id %}" class="btn btn-success w-100">Friend Requests</a>
						{% endif %}
					</div>
				</div>

				<!-- end friends section -->



			</div>

			<!-- column 3 -->

			<div class="col-md">
				<!-- profile gallery section -->
				<div class="card card-body mb-2"
					data-tg-tour="<h5>Here are your gallery images.</h5> <p>Add up to four images to your profile so people can see your photos. Lets get started! ðŸŽ‰</p>"
					data-tg-order="6">
					<h1><a href="{% url 'gallery' profile.id %}" class="text-decoration-none">{{ profile.user.first_name }}'s
							Gallery</a></h1>

					{% if request.user.profile == profile %}
					<form method="post" enctype="multipart/form-data" class="mt-3">
						{% csrf_token %}

						<!-- user gallery -->
						<div class="gallery-grid">
							<!-- Box 1 -->
							<div class="photo-slot">
								{% if user_photos|length > 0 %}
								<img src="{{ user_photos.0.thumbnail.url }}" class="uploaded-photo" data-bs-toggle="modal"
									data-bs-target="#ownerPhotoModal1" alt="Gallery photo 1">
								<!-- Modal -->
								<div class="modal fade" id="ownerPhotoModal1" tabindex="-1" aria-hidden="true">
									<div class="modal-dialog modal-dialog-centered modal-lg">
										<div class="modal-content">
											<div class="modal-body p-0">
												<img id="modal-image" data-src="{{ user_photos.0.image.url }}">
											</div>
										</div>
									</div>
								</div>
								{% if request.user.profile == profile %}
								<button type="button" class="remove-btn" data-photo-id="{{ user_photos.0.id }}"
									aria-label="Remove photo">Ã—</button>
								{% endif %}
								{% else %}
								<input type="file" name="image_0" id="photo-upload-0" accept="image/*" style="display:none;">
								<label for="photo-upload-0" class="add-photo-box">
									<span class="plus-sign">+</span>
								</label>
								{% endif %}
							</div>

							<!-- Box 2 -->
							<div class="photo-slot">
								{% if user_photos|length > 1 %}
								<img src="{{ user_photos.1.thumbnail.url }}" class="uploaded-photo" data-bs-toggle="modal"
									data-bs-target="#ownerPhotoModal2" alt="Gallery photo 2">
								<!-- Modal -->
								<div class="modal fade" id="ownerPhotoModal2" tabindex="-1" aria-hidden="true">
									<div class="modal-dialog modal-dialog-centered modal-lg">
										<div class="modal-content">
											<div class="modal-body p-0">
												<img id="modal-image" data-src="{{ user_photos.1.image.url }}">
											</div>
										</div>
									</div>
								</div>
								{% if request.user.profile == profile %}
								<button type="button" class="remove-btn" data-photo-id="{{ user_photos.1.id }}"
									aria-label="Remove photo">Ã—</button>
								{% endif %}
								{% else %}
								<input type="file" name="image_1" id="photo-upload-1" accept="image/*" style="display:none;">
								<label for="photo-upload-1" class="add-photo-box">
									<span class="plus-sign">+</span>
								</label>
								{% endif %}
							</div>

							<!-- Box 3 -->
							<div class="photo-slot">
								{% if user_photos|length > 2 %}
								<img src="{{ user_photos.2.thumbnail.url }}" class="uploaded-photo" data-bs-toggle="modal"
									data-bs-target="#ownerPhotoModal3" alt="Gallery photo 3">
								<!-- Modal -->
								<div class="modal fade" id="ownerPhotoModal3" tabindex="-1" aria-hidden="true">
									<div class="modal-dialog modal-dialog-centered modal-lg">
										<div class="modal-content">
											<div class="modal-body p-0">
												<img id="modal-image" data-src="{{ user_photos.2.image.url }}">
											</div>
										</div>
									</div>
								</div>
								{% if request.user.profile == profile %}
								<button type="button" class="remove-btn" data-photo-id="{{ user_photos.2.id }}"
									aria-label="Remove photo">Ã—</button>
								{% endif %}
								{% else %}
								<input type="file" name="image_2" id="photo-upload-2" accept="image/*" style="display:none;">
								<label for="photo-upload-2" class="add-photo-box">
									<span class="plus-sign">+</span>
								</label>
								{% endif %}
							</div>

							<!-- Box 4 -->
							<div class="photo-slot">
								{% if user_photos|length > 3 %}
								<img src="{{ user_photos.3.thumbnail.url }}" class="uploaded-photo" data-bs-toggle="modal"
									data-bs-target="#ownerPhotoModal4" alt="Gallery photo 4">
								<!-- Modal -->
								<div class="modal fade" id="ownerPhotoModal4" tabindex="-1" aria-hidden="true">
									<div class="modal-dialog modal-dialog-centered modal-lg">
										<div class="modal-content">
											<div class="modal-body p-0">
												<img id="modal-image" data-src="{{ user_photos.3.image.url }}">
											</div>
										</div>
									</div>
								</div>
								{% if request.user.profile == profile %}
								<button type="button" class="remove-btn" data-photo-id="{{ user_photos.3.id }}"
									aria-label="Remove photo">Ã—</button>
								{% endif %}
								{% else %}
								<input type="file" name="image_3" id="photo-upload-3" accept="image/*" style="display:none;">
								<label for="photo-upload-3" class="add-photo-box">
									<span class="plus-sign">+</span>
								</label>
								{% endif %}
							</div>
						</div>

					</form>
					{% else %}
					<!-- Visitor view: read-only thumbnails -->
					<div class="gallery-grid">
						{% for photo in user_photos %}
						<div id="vistor-image">
							<img src="{{ photo.thumbnail.url }}" id="vistor-thumbnail" data-bs-toggle="modal"
								data-bs-target="#photoModal{{ forloop.counter }}">
						</div>

						<!-- Modal for each photo -->
						<div class="modal fade" id="photoModal{{ forloop.counter }}" tabindex="-1" aria-hidden="true">
							<div class="modal-dialog modal-dialog-centered modal-lg">
								<div class="modal-content">
									<div class="modal-body p-0">
										<img id="modal-image" src="{{ photo.image.url }}">
									</div>
								</div>
							</div>
						</div>
						{% empty %}
						<p>No photos to show.</p>
						{% endfor %}
					</div>
					{% endif %}
				</div>
				<!-- end profile gallery section -->

				<!-- Invite Friend section -->
				{% if request.user.profile == profile %}
				<div class="card card-body">
					<h3>Invite a Friend To friendi</h3>
					<form method="post" action="">
						{% csrf_token %}
						{{ invite_friend_form.as_p }}
						<button type="submit" name="invite-friend" class="btn btn-success">Send Invitation</button>
					</form>
				</div>
				<!-- end invite friend form -->
				{% endif %}
			</div>
			<!-- end column 3 -->



		</div>
	</div>

	<!-- messaging modal -->
	<div class="modal fade" id="reg-modal" tabindex="-1" aria-labelledby="modal-title" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="modal-title">Send a message to {{ profile.user.first_name }}</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form method="post" action="{% url 'send_message' profile.id %}">
						{% csrf_token %}
						<div class="form-group">
							<label for="message-text" class="col-form-label">Message:</label>
							<textarea class="form-control" id="message-text" name="message" required></textarea>
						</div>
						<button type="submit" class="btn btn-success mt-2">Submit</button>
					</form>
				</div>
			</div>
		</div>
	</div>
	<!-- end -->

	<!-- DM not friend modal -->
	<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="exampleModalLabel">Only Friends Can Message</h1>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					Please send a friend request to {{ profile.user.first_name }}
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<!-- end -->


</section>

<div id="galleryLoadingOverlay" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(255, 255, 255, 0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  display: none;
">
	<canvas id="gallery-dotlottie-canvas" style="width: 300px; height: 300px;"></canvas>
</div>

<script type="module">
	import { DotLottie } from "https://cdn.jsdelivr.net/npm/@lottiefiles/dotlottie-web/+esm";
  window.DotLottie = DotLottie; // make it global
</script>



<script>
	document.addEventListener("DOMContentLoaded", function () {
		const removeButtons = document.querySelectorAll(".remove-btn");
		const photoInputs = document.querySelectorAll('input[type="file"][id^="photo-upload-"]');

		document.querySelectorAll('.modal').forEach(modal => {
			modal.addEventListener('show.bs.modal', function () {
				const img = this.querySelector('#modal-image');
				if (img && !img.src) {
					img.src = img.dataset.src;
				}
			});
		});

		// remove gallery photo JS
		removeButtons.forEach(btn => {
			btn.addEventListener("click", async (e) => {
				const photoId = e.currentTarget.getAttribute("data-photo-id");
				if (!photoId) return;

				const confirmDelete = confirm("Are you sure you want to remove this photo?");
				if (!confirmDelete) return;

				const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

				try {
					const response = await fetch("/remove-gallery-image/", {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
							"X-CSRFToken": csrfToken
						},
						body: JSON.stringify({
							photo_id: photoId
						})
					});

					if (response.ok) {
						location.reload();
					} else {
						alert("Failed to remove photo.");
					}
				} catch (error) {
					console.error("Error removing photo:", error);
				}
			});
		});

		// gallery upload JS
		photoInputs.forEach(input => {
			input.addEventListener("change", function () {
				const file = this.files[0];
				if (!file) return;

				const img = new Image();
				img.src = URL.createObjectURL(file);

				img.onload = () => {
					const minWidth = 400;
					const maxWidth = 4000;

					if (img.width < minWidth) {
						alert(`Image is too small. Minimum width is ${minWidth}px.`);
						this.value = ""; // clear input
						return;
					}
					if (img.width > maxWidth) {
						alert(`Image is too large. Maximum width is ${maxWidth}px.`);
						this.value = ""; // clear input
						return;
					}

					// Only after validation passes:
					const overlay = document.getElementById("galleryLoadingOverlay");
					overlay.style.display = "flex";

					new window.DotLottie({
						autoplay: true,
						loop: true,
						canvas: document.getElementById("gallery-dotlottie-canvas"),
						src: "https://lottie.host/047bfc54-8fe2-42d2-9631-ac15e86e346b/c4UbKclfSF.lottie",
					});

					setTimeout(() => {
						this.form.submit();
					}, 600);
				};
			});
		});
		/* const clearStatusBtn = document.getElementById("clear-status-btn");
		const clearStatusForm = document.getElementById("clear-status-form");

		if (clearStatusBtn && clearStatusForm) {
			clearStatusBtn.addEventListener("click", function (event) {
				event.preventDefault();
				clearStatusForm.submit();
			});
		} */

		const tg = new tourguide.TourGuideClient({
			exitOnClickOutside: false,
		})

		tg.start();


	});
</script>

{% endblock %}