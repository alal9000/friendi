{% extends "app/main.html" %} {% load static %} {% block content %}
<style>
  .viewport-height {
    min-height: 70vh;
    overflow-y: auto;
  }

  .avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
  }

  /* status-update styles */

  .status-update {
    border: 1px solid #ddd;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 5px;
    background-color: #f9f9f9;
  }

  .status-meta {
    font-size: 0.9em;
    color: #666;
  }

  .status-content {
    display: flex;
    align-items: center;
  }

  .status-text {
    margin-left: 10px;
  }

  .status-image img {
    max-width: 200px;
    height: auto;
    display: block;
    margin-top: 10px;
    cursor: pointer;
  }

  .like-button {
    border: none;
  }

  /* comment styles */
  .comment-meta {
    font-size: 0.9em;
    color: #666;
  }
</style>

<!-- CSRF token -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}" />

<div class="container">
  <div class="row">
    <div class="col">
      <h1>Post Detail</h1>
      <div class="status-update">
        <div class="status-content">
          {% if status.profile.profile_pic %}
          <img src="{{ status.profile.profile_pic.url }}" class="avatar img-fluid"
            alt="{{ status.profile.user.username }}" />
          {% else %}
          <img src="{% static 'images/default-avatar.png' %}" class="avatar img-fluid" alt="Default Avatar" />
          {% endif %}
          <p class="status-text">
            <strong>{{ status.profile.user.username }}</strong>:
            {{ status.content }}
          </p>
        </div>


        {% if status.image %}
        <div class="status-image">
          <img src="{{ status.image.url }}" alt="Status Image" onclick="showImage('{{ status.image.url }}')">
        </div>
        {% endif %}

        <p class="status-meta">Posted on {{ status.date_posted }}</p>

        <!-- Like Button -->
        <button class="like-button" data-status-id="{{ status.id }}">
          <span class="emoji">
            {% if user in status.liked_by.all %} ‚ù§Ô∏è {% else %} ü§ç {% endif %}
          </span>
          <span class="count">{{ status.like_count }}</span>
        </button>
        <span class="like-text" {% if user not in status.liked_by.all %} style="display: none;" {% endif %}>
          <em>You like this</em>
        </span>
        <!-- End Like Button -->

        <!-- Comments Section -->
        <!-- Add a new comment -->
        <form action="{% url 'post_comment' status.id %}" data-status-id="{{ status.id }}" class="comment-form">
          {% csrf_token %}
          <input type="text" class="form-control" placeholder="Write a comment..." />
          <button type="submit">Post Reply</button>
        </form>
        <!-- End Add a new comment -->

        <!-- Existing comments -->
        <div class="comments">
          {% for comment in status.comments.all reversed %}
          <div id="comment-{{ comment.id }}" class="comment">
            <strong>
              <a href="{% url 'profile' comment.author.id %}">
                {{ comment.author.first_name }} {{ comment.author.last_name }}:
              </a>
            </strong>
            <span class="comment-content">{{ comment.content }}</span>
            <span class="comment-meta">{{ comment.created_at }}</span>

            <!-- Reply Link (initially visible) -->
            <a href="javascript:void(0);" class="reply-link" data-comment-id="{{ comment.id }}"
              style="color: blue; text-decoration: underline;">Reply</a>
            <!-- End Reply Link -->

            <!-- Reply Form (initially hidden) -->
            <form data-comment-id="{{ comment.id }}" class="reply-form" data-status-id="{{ status.id }}"
              style="display: none; margin-top: 10px;">
              {% csrf_token %}
              <input type="text" class="form-control" id="replyInput-{{ comment.id }}" placeholder="Write a reply...">
              <button type="button" class="cancel-reply">Cancel</button>
              <button type="submit">Post Reply</button>
            </form>
            <!-- End Reply Form -->


          </div>
          <hr>
          {% endfor %}
        </div>
        <!-- End Existing comments -->
        <!-- End Comments Section -->

      </div>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <img id="modalImage" src="" alt="Status Image" class="img-fluid">
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {

    replyToPost();
    replyToComment();
    scrollToComment();

    // bold the @name's for existing comments
    document.querySelectorAll('.comment-content').forEach(comment => {
      comment.innerHTML = comment.innerHTML.replace(/@(\w+)\s(\w+):/g,
        '<strong>@$1 $2:</strong>');
    });

    // like functionality
    const likeButton = document.querySelector(".like-button");
    if (likeButton) {
      likeButton.addEventListener("click", function () {
        const statusId = this.getAttribute("data-status-id");
        toggleLike(statusId, likeButton);
      });
    }
  }); // DOMContentLoaded finishes

  // scroll to the comment when replying from newsfeed page
  function scrollToComment() {
    // Handle scroll to post and comment
    const params = new URLSearchParams(window.location.search);
    const commentId = params.get("comment_id");
    const focus = params.get("focus");

    // scroll to comment
    if (commentId) {
      expandCommentForm(commentId);
      const targetComment = document.getElementById(`comment-${commentId}`);
      if (targetComment) {
        targetComment.scrollIntoView({
          behavior: "smooth",
          block: "start"
        });
        targetComment.style.backgroundColor = "#ffffcc"; // Highlight effect
        setTimeout(() => targetComment.style.backgroundColor = "", 2000); // Remove highlight after 2s

        // extract author's name and prefill input
        const replyInput = document.getElementById(`replyInput-${commentId}`);
        if (replyInput) {
          const authorNameElement = targetComment.querySelector('strong a');
          if (authorNameElement) {
            const authorName = authorNameElement.innerText.trim();
            const [firstName, lastName] = authorName.split(' ');

            // Pre-fill the input with the author's name
            replyInput.value = `@${firstName} ${lastName} `;
            replyInput.focus();

            // prevent user from deleting the prefilled text
            replyInput.addEventListener('keydown', function (event) {
              const cursorPosition = replyInput.selectionStart;
              const prefixLength = `@${firstName} ${lastName} `.length;

              if (event.key === 'Backspace' && cursorPosition <= prefixLength) {
                event.preventDefault(); // Prevent backspace if cursor is within the prefilled text
              }
            });
          }
        }
      }
    }

    // scroll to post and input focus
    if (focus === "post") {
      const commentInput = document.querySelector('form[data-status-id="{{ status.id }}"] input[type="text"]');
      if (commentInput) {
        commentInput.focus(); // Focus on the input
        commentInput.scrollIntoView({
          behavior: "smooth",
          block: "center"
        });
      }
    }

    // Function to expand the comment when coming from newsfeed page based on the 'comment_id'
    function expandCommentForm(commentId) {
      // Find the form with the matching 'data-comment-id' attribute
      const commentForm = document.querySelector(`.reply-form[data-comment-id="${commentId}"]`);
      if (commentForm) {
        // Expand the form (change the display property to show it)
        commentForm.style.display = 'block'; // For example, change display to 'block'

        const replyInput = document.getElementById(`replyInput-${commentId}`);
        replyInput.focus();

        // Pre-fill the reply input with @<firstname-lastname>
        const authorName = commentForm.closest('.comment').querySelector('strong a').innerText;
        replyInput.value = `@${authorName} `;

        // Prevent removing the prepend text
        replyInput.addEventListener('keydown', function handleKeyDown(event) {
          const cursorPosition = replyInput.selectionStart;
          if (event.key === 'Backspace' && cursorPosition <= `@${authorName} `.length) {
            event.preventDefault();
          }
        }, {
          once: true
        });

        // Handle form submission
        commentForm.addEventListener('submit', function handleSubmit(event) {
          event.preventDefault();

          const statusId = commentForm.getAttribute('data-status-id');
          const content = replyInput.value;

          if (content.trim() === '') return;

          postComment(content, statusId)
            .then(data => {
              if (data.success) {
                commentForm.querySelector('input[type="text"]').value = '';
                commentForm.style.display = 'none';
                const commentsContainer = document.querySelector('.comments');
                const boldedContent = data.content.replace(/@(\w+)\s(\w+):/g, '<strong>@$1 $2:</strong>');

                const newComment = `
              <div class="comment" id="comment-${data.comment_id}">
                <strong>
                  <a href="/profile/${statusId}/">${data.author}:</a>
                </strong>
                ${boldedContent}
                <span class="comment-meta">${data.created_at}</span>
                <a href="javascript:void(0);" class="reply-link" data-comment-id="${data.comment_id}">Reply</a>
                <form data-comment-id="${data.comment_id}" class="reply-form" style="display: none;">
                  {% csrf_token %}
                  <input type="text" id="replyInput-${data.comment_id}" placeholder="Write a reply...">
                  <button type="button" class="cancel-reply">Cancel</button>
                  <button type="submit">Post Reply</button>
                </form>
              </div>
              <hr>
            `;

                commentsContainer.insertAdjacentHTML('afterbegin', newComment);
              }
            })
            .catch(err => {
              console.error(err);
              alert("Error posting comment");
            });
        }, {
          once: true
        });
      }
    }
  }

  // reply to a post functionality
  function replyToPost() {

    const commentform = document.querySelector('.comment-form');
    commentform.addEventListener('submit', (e) => {
      e.preventDefault();

      const statusId = commentform.getAttribute('data-status-id');
      const content = commentform.querySelector('input[type="text"]').value;

      if (content.trim() === '') return;

      postComment(content, statusId)
        .then(data => {
          if (data.success) {
            const commentsContainer = commentform.nextElementSibling;
            const newComment = `
            <div class="comment" id="comment-${data.comment_id}">
              <strong>
                <a href="/profile/${statusId}/">
                  ${data.author}:
                </a>
              </strong>
              ${data.content}
              <span class="comment-meta">${data.created_at}</span>

              <!-- Reply Link (initially visible) -->
              <a href="javascript:void(0);" class="reply-link" data-comment-id="${data.comment_id}"
                style="color: blue; text-decoration: underline;">Reply</a>

              <!-- Reply Form (initially hidden) -->
              <form data-comment-id="${data.comment_id}" class="reply-form" style="display: none; margin-top: 10px;">
                {% csrf_token %}
                <input type="text" class="form-control" id="replyInput-${data.comment_id}" placeholder="Write a reply...">
                <button type="button" class="cancel-reply">Cancel</button>
                <button type="submit">Post Reply</button>
              </form>
              <!-- End Reply Form -->
            </div>
            <hr>
          `;

            commentsContainer.insertAdjacentHTML('afterbegin', newComment);
            commentform.querySelector('input[type="text"]').value = '';
          }
        })
        .catch(err => {
          console.error(err);
          alert("There was an error posting your comment. Please try again.");
        })

    }); // finish submit event listener for comment
  }

  // reply to a comment on a post functionality
  function replyToComment() {
    // Handle reply link clicks
    const replyLinks = document.querySelectorAll('.reply-link');
    replyLinks.forEach(link => {
      link.addEventListener('click', (event) => {
        const commentId = link.getAttribute('data-comment-id');
        const replyForm = document.querySelector(`.reply-form[data-comment-id="${commentId}"]`);
        const replyInput = document.getElementById(`replyInput-${commentId}`);

        // Toggle the visibility of the reply form
        if (replyForm) {
          replyForm.style.display = 'block'; // Show the reply form
          replyInput.focus(); // Focus the reply input

          // Pre-fill the reply input with @<firstname-lastname>
          const authorFirstName = link.closest('.comment').querySelector('strong a').innerText.split(' ')[
            0];
          const authorLastName = link.closest('.comment').querySelector('strong a').innerText.split(' ')[1];
          replyInput.value = `@${authorFirstName} ${authorLastName} `;

          // Prevent removing the prepend text
          replyInput.addEventListener('keydown', function (event) {
            const currentText = replyInput.value;
            const cursorPosition = replyInput.selectionStart;

            // If the user is trying to delete or backspace before the prepend text, prevent it
            if (event.key === 'Backspace' && cursorPosition <= `@${authorFirstName} ${authorLastName} `
              .length) {
              event.preventDefault();
            }
          });

          // Handle form submission for the corresponding comment reply form
          replyForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const statusId = replyForm.getAttribute('data-status-id');
            const content = replyForm.querySelector('input[type="text"]').value;

            if (content.trim() === '') return;

            postComment(content, statusId)
              .then(data => {
                if (data.success) {
                  const commentsContainer = document.querySelector('.comments');
                  const boldedContent = data.content.replace(/@(\w+)\s(\w+):/g,
                    '<strong>@$1 $2:</strong>');
                  const newComment = `
                <div class="comment" id="comment-${data.comment_id}">
                  <strong>
                    <a href="/profile/${statusId}/">
                      ${data.author}:
                    </a>
                  </strong>
                  ${boldedContent}
                  <span class="comment-meta">${data.created_at}</span>
    
                  <!-- Reply Link (initially visible) -->
                  <a href="javascript:void(0);" class="reply-link" data-comment-id="${data.comment_id}"
                    style="color: blue; text-decoration: underline;">Reply</a>
    
                  <!-- Reply Form (initially hidden) -->
                  <form data-comment-id="${data.comment_id}" class="reply-form" style="display: none; margin-top: 10px;">
                    {% csrf_token %}
                    <input type="text" class="form-control" id="replyInput-${data.comment_id}" placeholder="Write a reply...">
                    <button type="button" class="cancel-reply">Cancel</button>
                    <button type="submit">Post Reply</button>
                  </form>
                  <!-- End Reply Form -->
                </div>
                <hr>
              `;

                  commentsContainer.insertAdjacentHTML('afterbegin', newComment);
                  replyForm.querySelector('input[type="text"]').value = '';
                }
              })
              .catch(err => {
                console.error(err);
                alert("There was an error posting your comment. Please try again.");
              })
          })

        }
      });
    });

    // Handle Cancel Button Click
    const cancelButtons = document.querySelectorAll('.cancel-reply');
    cancelButtons.forEach(button => {
      button.addEventListener('click', (event) => {
        const form = event.target.closest('form'); // Find the parent form
        const input = form.querySelector('input'); // Find the input field

        // Hide the reply form and reset the input value
        form.style.display = 'none';
        input.value = ''; // Reset input field
      });
    });
  }

  // fetch api request
  function postComment(content, statusId) {
    return fetch(`/post_comment/${statusId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCSRFToken(),
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          content
        }),
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          return data;
        } else {
          throw new Error('Failed to post comment');
        }
      })
      .catch(err => {
        console.error(err);
        alert("There was an error posting your comment. Please try again.");
      });
  }

  // toggle like functionality
  function toggleLike(statusId, button) {
    fetch(`/react/${statusId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCSRFToken(),
          "Content-Type": "application/json",
        },
      })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const countElement = button.querySelector('.count');
          countElement.textContent = data.like_count;

          // Toggle the heart color based on like status
          button.querySelector(".emoji").textContent = data.isLiked ? "‚ù§Ô∏è" : "ü§ç";

          const likeText = button.nextElementSibling; // Assuming like-text is right after button
          likeText.style.display = data.isLiked ? "inline" : "none";
        } else {
          console.error("Error:", data.error);
        }
      })
      .catch((error) => console.error("Error:", error));
  }
  // read the csrf token to make requests
  function getCSRFToken() {
    return document.querySelector("[name=csrfmiddlewaretoken]").value;
  }

  // Modal to show image
  function showImage(imageUrl) {
    document.getElementById('modalImage').src = imageUrl;
    var myModal = new bootstrap.Modal(document.getElementById('imageModal'));
    myModal.show();
  }
</script>

{% endblock %}